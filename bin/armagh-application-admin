#!/usr/bin/env ruby

# Copyright 2017 Noragh Analytics, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
# express or implied.
#
# See the License for the specific language governing permissions and
# limitations under the License.
#

require 'sinatra'
require 'thin'
require 'json'
require 'log4r'

require_relative '../lib/environment.rb'
Armagh::Environment.init

require_relative '../lib/admin/application/api.rb'
require_relative '../lib/admin/application/thin_backend.rb'
require_relative '../lib/configuration/file_based_configuration.rb'
require_relative '../lib/logging'

require_relative '../lib/utils/rest_helper'

Process.setproctitle(File.basename(__FILE__))

#------------------------------------------------------------------------------------------------
#
# SET UP ENVIRONMENT
#
#------------------------------------------------------------------------------------------------

include Armagh

api = Admin::Application::API.instance
rest_helper = Utils::RestHelper.new(api.logger)

Authentication::User.setup_default_users
Authentication::Group.setup_default_groups

configure do

  if ENV[ 'ARMAGH_ENV' ] == 'PRODUCTION'
    set :environment, :production
  else
    set :environment, :development
    set :show_exceptions, :after_handler
  end

  set :bind,   api.ip
  set :port,   api.port
  set :server, "thin"
  set :root,   api.root_directory
  set :run,    true
  class << settings

    def server_settings

      api = Admin::Application::API.instance

      settings = { :backend => Admin::Application::ThinBackend }
      if api.using_ssl?
        settings.merge!( {
                             :private_key_file => api.key_filepath,
                             :cert_chain_file  => api.cert_filepath,
                             :verify_peer      => api.verify_peer
                         })
      end
      settings
    end
  end
end # end configure

enable :sessions, :logging

set :session_secret, 'arm-866w(c@n$f2pv+8sgg7&y_i#c+6!-d(u&f*dec7sp!ju*a%9*a'

use Rack::CommonLogger, api.logger

use Rack::Auth::Basic, 'Armagh Admin' do |username, password|
  api.authenticate_and_authorize username, password
end # use Rack::Auth::Basic

#------------------------------------------------------------------------------------------------
#
# REST API
#
#------------------------------------------------------------------------------------------------

helpers do
end

get '/status.json' do
  rest_helper.handle_request( 'get status', request ) do |fields|
    api.get_status
  end
end

#------------------------------
#
# launcher
#
#------------------------------
post '/launcher.json' do
  rest_helper.handle_request('get launcher', request ) do |fields|
    api.create_or_update_launcher_configuration(fields)
  end
end

#------------------------------
#
# agent
#
#------------------------------

post '/agent.json' do
  # TODO Agent configuration
end

#------------------------------
#
# workflow
#
#------------------------------

# list of workflows with status
get '/workflows.json' do
  rest_helper.handle_request('get workflows', request) do |fields|
    api.get_workflows
  end
end

# create new workflow
get '/workflow/:workflow_name/new.json' do
  rest_helper.handle_request('get workflow/NAME/new', request) do |fields|
    workflow = api.create_workflow({'workflow' => {'name' => params['workflow_name']}})
    workflow.name
  end
end

# status for existing workflow
get '/workflow/:workflow_name/status.json' do
  rest_helper.handle_request('get workflow/NAME/status', request ) do |fields|
    api.get_workflow_status(params['workflow_name'])
  end
end

# update workflow: run
get '/workflow/:workflow_name/run.json' do
  rest_helper.handle_request('get workflow/NAME/run', request) do |fields|
    api.run_workflow(params['workflow_name'])
  end
end

# update workflow: finish
get '/workflow/:workflow_name/finish.json' do
  rest_helper.handle_request('get workflow/NAME/finish', request) do |fields|
    api.finish_workflow(params['workflow_name'])
  end
end

# update workflow: stop
get '/workflow/:workflow_name/stop.json' do
  rest_helper.handle_request('get workflow/NAME/stop', request) do |fields|
    api.stop_workflow(params['workflow_name'])
  end
end

#------------------------------
#
# workflow actions
#
#------------------------------

# list of defined action classes
get '/actions/defined.json' do
  rest_helper.handle_request('get actions/defined', request) do |fields|
    api.get_defined_actions
  end
end

# Trigger a collect
get '/actions/trigger_collect.json' do
  rest_helper.handle_request('get actions/trigger_collect', request) do |fields|
    api.trigger_collect(params['name'])
  end
end

# list of workflow actions with status
get '/workflow/:workflow_name/actions.json' do
  rest_helper.handle_request('get workflow/NAME/actions', request) do |fields|
    api.get_workflow_actions(params['workflow_name'])
  end
end

# status for existing workflow action
get '/workflow/:workflow_name/action/:action_name/status.json' do
  rest_helper.handle_request('get workflow/NAME/action/NAME/status', request) do |fields|
    api.get_workflow_action_status(params['workflow_name'], params['action_name'])
  end
end

# edit form for new workflow action
get '/workflow/:workflow_name/action/config.json' do
  rest_helper.handle_request('get workflow/NAME/action/config', request) do |fields|
    api.new_workflow_action_config(params['workflow_name'],fields['type'] )
  end
end

# edit form for existing workflow action
get '/workflow/:workflow_name/action/:action_name/description.json' do
  rest_helper.handle_request('workflow/NAME/action/NAME/description', request) do |fields|
    api.get_workflow_action_description(params['workflow_name'], params['action_name'])
  end
end

get '/workflow/:workflow_name/action/:action_name/config.json' do
  rest_helper.handle_request('workflow/NAME/action/NAME/config', request) do |fields|
    api.get_workflow_action_config(params['workflow_name'], params['action_name'])
  end
end

# submit params to create workflow action
post '/workflow/:workflow_name/action/config.json' do
  rest_helper.handle_request('workflow/NAME/action/NAME/config', request) do |fields|
    type = fields.delete 'type'
    api.create_workflow_action_config(params['workflow_name'], type, fields)
  end
end

# submit params to change existing action config
post '/workflow/:workflow_name/action/:action_name/config.json' do
  rest_helper.handle_request('workflow/NAME/action/NAME/config', request) do |fields|
    api.update_workflow_action_config(params['workflow_name'], params['action_name'], fields )
  end
end

#---------------------
#
# documents
#
#---------------------

get '/documents.json' do
  rest_helper.handle_request('get documents', request) do |_fields|
    doc_type = params['type']
    return rest_helper.respond_client_error(request, 'Missing parameter: type') if doc_type.nil? || doc_type.empty?

    begin_ts = Time.parse(params['begin_ts']) if params.include? 'begin_ts'
    end_ts = Time.parse(params['end_ts']) if params.include? 'end_ts'
    start_index = params['start_index'].to_i if params.include? 'start_index'
    max_returns = params['max_returns'].to_i if params.include? 'max_returns'

    api.get_documents(doc_type, begin_ts, end_ts, start_index, max_returns)
  end
end

get '/document.json' do
  rest_helper.handle_request('get document', request) do |_fields|
    doc_id = params['id']
    doc_type = params['type']

    return rest_helper.respond_client_error(request, 'Missing parameter: id') if doc_id.nil? || doc_id.empty?
    return rest_helper.respond_client_error(request, 'Missing parameter: type') if doc_type.nil? || doc_type.empty?

    api.get_document(doc_id, doc_type)
  end
end

get '/documents/failures.json' do
  rest_helper.handle_request('get documents/failures', request) do |_fields|
    api.get_failed_documents
  end
end

get '/version.json' do
  rest_helper.handle_request('get version', request) do |_fields|
    api.get_version
  end
end
